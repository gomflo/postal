---
import "../../styles/global.css";
import Breadcrumb from "../../components/Breadcrumb.astro";
import SiteHeader from "../../components/SiteHeader.astro";
import ThemeScript from "../../components/ThemeScript.astro";
import estados from "../../data/estados.json";
import { supabase } from "../../lib/supabase";
import { slugify, slugForAsentamiento } from "../../lib/slug";

type AsentamientoRow = {
  id: string;
  asentamiento: string;
  codigo_postal: string;
};

export async function getStaticPaths() {
  const isDev = import.meta.env.DEV;
  const BATCH = 1000;
  const CONCURRENCY = 12;
  const MAX_ESTADOS_DEV = 2;
  const MAX_CIUDADES_DEV = 4;

  const allPaths: Array<{
    params: { clave: string; ciudad: string };
    props: { estado: string; ciudad: string; asentamientos: AsentamientoRow[] };
  }> = [];

  async function getCiudadesPorEstado(clave_estado: string): Promise<string[]> {
    const ciudadesSet = new Set<string>();
    let from = 0;
    while (true) {
      const { data, error } = await supabase
        .from("postal_codes")
        .select("ciudad")
        .eq("clave_estado", clave_estado)
        .order("ciudad", { nullsFirst: false })
        .range(from, from + BATCH - 1);
      if (error) throw error;
      if (!data?.length) break;
      for (const row of data) {
        if (row.ciudad?.trim()) ciudadesSet.add(row.ciudad.trim());
      }
      if (data.length < BATCH) break;
      from += BATCH;
    }
    return [...ciudadesSet].sort((a, b) => a.localeCompare(b, "es"));
  }

  async function getAsentamientosPorCiudad(
    clave_estado: string,
    ciudad: string
  ): Promise<AsentamientoRow[]> {
    const rows: AsentamientoRow[] = [];
    let from = 0;
    while (true) {
      const { data, error } = await supabase
        .from("postal_codes")
        .select("id, asentamiento, codigo_postal")
        .eq("clave_estado", clave_estado)
        .eq("ciudad", ciudad)
        .order("asentamiento", { nullsFirst: false })
        .range(from, from + BATCH - 1);
      if (error) throw error;
      if (!data?.length) break;
      rows.push(...(data as AsentamientoRow[]));
      if (data.length < BATCH) break;
      from += BATCH;
    }
    return rows;
  }

  const estadosToProcess = isDev ? estados.slice(0, MAX_ESTADOS_DEV) : estados;

  for (const { clave_estado, estado } of estadosToProcess) {
    const ciudadesRaw = await getCiudadesPorEstado(clave_estado);
    const ciudades = isDev ? ciudadesRaw.slice(0, MAX_CIUDADES_DEV) : ciudadesRaw;
    for (let i = 0; i < ciudades.length; i += CONCURRENCY) {
      const chunk = ciudades.slice(i, i + CONCURRENCY);
      const chunkResults = await Promise.all(
        chunk.map(async (ciudad) => {
          const asentamientos = await getAsentamientosPorCiudad(clave_estado, ciudad);
          return {
            params: { clave: slugify(estado), ciudad: slugify(ciudad) },
            props: { estado, ciudad, asentamientos },
          };
        })
      );
      allPaths.push(...chunkResults);
    }
  }

  return allPaths;
}

const { estado, ciudad, asentamientos } = Astro.props;
const base = import.meta.env.BASE_URL;
const title = `Colonias en ${ciudad}, ${estado} | Postali`;
const description = `Colonias y asentamientos en ${ciudad}, ${estado}. ${asentamientos.length} códigos postales.`;
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <ThemeScript />
    <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
    <link rel="icon" href={`${base}/favicon.ico`} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
  </head>
  <body class="min-h-screen bg-background text-foreground">
    <a href="#main" class="skip-link">Ir al contenido</a>
    <SiteHeader />
    <main id="main" class="mx-auto max-w-2xl px-4 py-16 sm:py-24" tabindex="-1">
      <Breadcrumb
        items={[
          { label: "Inicio", href: `${base}/` },
          { label: estado, href: `${base}/${Astro.params.clave}` },
          { label: ciudad },
        ]}
      />

      <h1 class="text-2xl font-semibold tracking-tight text-pretty">
        Colonias y asentamientos en {ciudad}, {estado}
      </h1>
      <p class="mt-2 text-muted-foreground text-base">
        {asentamientos.length} {asentamientos.length === 1 ? "código postal" : "códigos postales"}.
      </p>

      {asentamientos.length > 0 ? (
        <section class="mt-8" aria-labelledby="colonias-heading">
          <h2
            id="colonias-heading"
            class="sr-only"
          >
            Listado de colonias y asentamientos
          </h2>
          <ul class="grid grid-cols-2 gap-2 sm:gap-3" role="list">
            {asentamientos.map((row) => (
              <li>
                <a
                  href={`${base}/${slugForAsentamiento(row.asentamiento, row.codigo_postal)}`}
                  class="h-16 flex items-center rounded-lg border border-border bg-card px-4 py-3 text-sm font-medium text-card-foreground transition-colors duration-200 hover:bg-accent hover:text-accent-foreground hover:border-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background cursor-pointer touch-manipulation text-balance"
                >
                  {row.asentamiento}
                </a>
              </li>
            ))}
          </ul>
        </section>
      ) : (
        <p class="mt-6 text-muted-foreground text-sm">No hay colonias registradas para esta ciudad.</p>
      )}
    </main>
    <footer class="px-4 py-6 text-right">
      <a
        href="https://gomflo.dev"
        target="_blank"
        rel="noopener noreferrer"
        class="text-muted-foreground text-sm hover:text-foreground transition-colors"
      >
        by gomflo
      </a>
    </footer>
  </body>
</html>
