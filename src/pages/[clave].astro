---
import "../styles/global.css";
import { DetailView } from "../components/DetailView";
import Breadcrumb from "../components/Breadcrumb.astro";
import BreadcrumbSchema from "../components/BreadcrumbSchema.astro";
import SiteHeader from "../components/SiteHeader.astro";
import ThemeScript from "../components/ThemeScript.astro";
import estados from "../data/estados.json";
import { supabase } from "../lib/supabase";
import type { PostalCodeRow } from "../lib/supabase";
import { slugify, slugForAsentamiento } from "../lib/slug";
import { SITE_BASE, truncate, META_DESC_MAX, TITLE_MAX } from "../lib/seo";
const base = import.meta.env.BASE_URL;

export async function getStaticPaths() {
  const BATCH = 1000;
  const isDev = import.meta.env.DEV;
  const estadosToProcess = isDev ? estados.slice(0, 3) : estados;

  const estadoPaths = await Promise.all(
    estadosToProcess.map(async ({ clave_estado, estado }) => {
      const ciudadesSet = new Set<string>();
      let from = 0;

      while (true) {
        const { data, error } = await supabase
          .from("postal_codes")
          .select("ciudad")
          .eq("clave_estado", clave_estado)
          .order("ciudad", { nullsFirst: false })
          .range(from, from + BATCH - 1);

        if (error) throw error;
        if (!data?.length) break;

        for (const row of data) {
          if (row.ciudad?.trim()) ciudadesSet.add(row.ciudad.trim());
        }
        if (data.length < BATCH) break;
        from += BATCH;
      }

      const ciudades = [...ciudadesSet].sort((a, b) => a.localeCompare(b, "es"));
      return {
        params: { clave: slugify(estado) },
        props: { kind: "estado" as const, estado, ciudades },
      };
    })
  );

  const asentamientoSlugToRow = new Map<string, PostalCodeRow>();
  let from = 0;
  while (true) {
    const { data, error } = await supabase
      .from("postal_codes")
      .select("*")
      .range(from, from + BATCH - 1);
    if (error) throw error;
    if (!data?.length) break;
    for (const row of data as PostalCodeRow[]) {
      const slug = slugForAsentamiento(row.asentamiento, row.codigo_postal);
      if (!asentamientoSlugToRow.has(slug)) asentamientoSlugToRow.set(slug, row);
    }
    if (data.length < BATCH) break;
    from += BATCH;
  }

  const asentamientoPaths = [...asentamientoSlugToRow.entries()].map(([slug, row]) => ({
    params: { clave: slug },
    props: { kind: "asentamiento" as const, row },
  }));

  return [...estadoPaths, ...asentamientoPaths];
}

const props = Astro.props;
const rawTitle =
  props.kind === "estado"
    ? `${props.estado} — Códigos postales | Postali`
    : `${props.row.asentamiento} — ${props.row.codigo_postal} | Postali`;
const title = truncate(rawTitle, TITLE_MAX);
const rawDescription =
  props.kind === "estado"
    ? `Códigos postales de ${props.estado}. Ciudades: ${props.ciudades.length}.`
    : `Código postal ${props.row.codigo_postal}: ${props.row.asentamiento}, ${props.row.municipio}, ${props.row.estado}.`;
const description = truncate(rawDescription, META_DESC_MAX);
const canonical =
  props.kind === "estado"
    ? `${SITE_BASE}/${Astro.params.clave}`
    : `${SITE_BASE}/${Astro.params.clave}`;
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <ThemeScript />
    <link rel="canonical" href={canonical} />
    <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
    <link rel="icon" href={`${base}/favicon.ico`} />
    <meta name="description" content={description} />
    <title>{title}</title>
    <meta name="generator" content={Astro.generator} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:locale" content="es_MX" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <BreadcrumbSchema
      items={
        props.kind === "estado"
          ? [{ label: "Inicio", href: `${base}/` }, { label: props.estado }]
          : [
              { label: "Inicio", href: `${base}/` },
              { label: props.row.estado, href: `${base}/${slugify(props.row.estado)}` },
              ...(props.row.ciudad?.trim()
                ? [
                    { label: props.row.ciudad, href: `${base}/${slugify(props.row.estado)}/${slugify(props.row.ciudad)}` },
                    { label: props.row.asentamiento },
                  ]
                : [{ label: props.row.asentamiento }]),
            ]
      }
      currentPageUrl={canonical}
    />
  </head>
  <body class="min-h-screen bg-background text-foreground">
    <a href="#main" class="skip-link">Ir al contenido</a>
    <SiteHeader />
    <main id="main" tabindex="-1">
      {props.kind === "estado" ? (
        <div class="mx-auto max-w-2xl px-4 py-16 sm:py-24">
          <Breadcrumb
            items={[
              { label: "Inicio", href: `${base}/` },
              { label: props.estado },
            ]}
          />
          <h1 class="text-2xl font-semibold tracking-tight text-pretty">{props.estado}</h1>
          <p class="mt-2 text-muted-foreground text-base">
            Códigos postales de {props.estado}. Usa la búsqueda en la página principal para encontrar colonias.
          </p>

          {props.ciudades.length > 0 ? (
            <section class="mt-8" aria-labelledby="ciudades-heading">
              <h2
                id="ciudades-heading"
                class="text-center text-sm font-medium uppercase tracking-wider text-muted-foreground text-pretty mb-4"
              >
                Ciudades ({props.ciudades.length})
              </h2>
              <ul class="grid grid-cols-2 gap-2 sm:gap-3" role="list">
                {props.ciudades.map((ciudad) => (
                  <li>
                    <a
                      href={`${base}/${Astro.params.clave}/${slugify(ciudad)}`}
                      class="h-16 flex items-center rounded-lg border border-border bg-card px-4 py-3 text-sm font-medium text-card-foreground transition-colors duration-200 hover:bg-accent hover:text-accent-foreground hover:border-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background cursor-pointer touch-manipulation text-balance"
                    >
                      {ciudad}
                    </a>
                  </li>
                ))}
              </ul>
            </section>
          ) : (
            <p class="mt-6 text-muted-foreground text-sm">No hay ciudades registradas para este estado.</p>
          )}
        </div>
      ) : (
        <>
          <div class="mx-auto max-w-2xl px-4 pt-8">
            <Breadcrumb
              items={[
                { label: "Inicio", href: `${base}/` },
                { label: props.row.estado, href: `${base}/${slugify(props.row.estado)}` },
                ...(props.row.ciudad?.trim()
                  ? [
                      { label: props.row.ciudad, href: `${base}/${slugify(props.row.estado)}/${slugify(props.row.ciudad)}` },
                      { label: props.row.asentamiento },
                    ]
                  : [{ label: props.row.asentamiento }]),
              ]}
            />
          </div>
          <DetailView row={props.row} client:load />
          <footer class="px-4 py-6 text-right">
            <a
              href="https://gomflo.dev"
              target="_blank"
              rel="noopener noreferrer"
              class="text-muted-foreground text-sm hover:text-foreground transition-colors"
            >
              by gomflo
            </a>
          </footer>
        </>
      )}
    </main>
  </body>
</html>
